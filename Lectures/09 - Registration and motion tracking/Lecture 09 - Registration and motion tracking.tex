\documentclass[9pt, aspectratio=169]{beamer}
\usepackage{FiraSans}
\usetheme[subsectionpage=progressbar]{metropolis}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{multicol}
\usepackage{tikz}
\usetikzlibrary{math, calc}
\usepackage{caption}
\usepackage{xcolor}
\usepackage[T1]{fontenc} 
\usepackage[skins]{tcolorbox}
\author{Nicola Roman\`o - nicola.romano@ed.ac.uk}
\title{Lecture 09 - Registration and motion tracking}
\setlength{\fboxsep}{0pt}
\setbeamertemplate {footline}{\begin{scriptsize}\hfill\insertframenumber ~of \inserttotalframenumber\kern1em\vskip5pt\end{scriptsize}}

% Remove "Figure" in front of captions
% See https://tex.stackexchange.com/questions/82456/how-to-remove-figure-caption-prefix-figure-in-beamer
\captionsetup{labelformat=empty,labelsep=none}

\titlegraphic{\centering \includegraphics[scale=.5]{instituteLogo.png}}
\date{}

\begin{document}

\newtcolorbox{codebox}{enhanced,
    top=2pt,
    left=2pt,
    right=2pt,
    bottom=2pt,
    boxrule=0pt,
    leftrule=5pt,
    sharp corners,
    colback=gray!20,
    colframe=blue!60!black}

\begin{frame}
    \titlepage
\end{frame}

\begin{frame}
    {Learning objectives}
    \begin{columns}
        \begin{column}{0.8\textwidth}
            \begin{itemize}
                \item Describe the challenges related to working with videos
                \item Describe some of the approaches to video registration
                \item Describe some of the approaches related to motion tracking
            \end{itemize}
        \end{column}
        \begin{column}{0.2\textwidth}
            \includegraphics[angle=-30, origin=tr, width=1.5\textwidth]{lightbulb.png}
        \end{column}
    \end{columns}
\end{frame}

\section{Introduction - working with videos}

\begin{frame}
    {Reminder from lecture 1...}
    A video is just a sequence of images, that we can store in a tensor with 3 or more dimensions.

    \begin{tikzpicture}[scale=.9]
        \foreach \i [count=\n] in {-1,-0.6,...,1.4}
            {
                \node (A) at ({-\i+1.2}, {-\i+1.2}) {};
                \node (B) at ({-\i}, {-\i}) {};

                \draw[black,very thin, fill=white] (A) rectangle (B);
                \tikzmath{\frame = int(7-\n);}
                \node[anchor=south west] at (-\i, -\i+.8) {Fr. \frame};
            }

        \node [anchor=north] at (.6, 3.5) {\textbf{2D video (3D tensor)}};

        \foreach \i [count=\n] in {-1,-0.4,...,3}
            {
                %   G----A
                %  /|   / |
                % H-----C |
                % | B---|-E
                % |/    |/
                % D-----F
                \node (A) at (-\i+5.4, -\i+1.4) {};
                \node (B) at (-\i+4.2, -\i+0.2) {};
                \node (C) at (-\i+5.2, -\i+1.2) {};
                \node (D) at (-\i+4, -\i) {};
                \node (E) at (-\i+5.4, -\i+0.2) {};
                \node (F) at (-\i+5.2, -\i) {};
                \node (G) at (-\i+4.2, -\i+1.4) {};
                \node (H) at (-\i+4, -\i+1.2) {};

                % Back of the 3D stack
                \draw[black,very thin, fill=white] (A) rectangle (B);
                % Front of the 3D stack
                \draw[black,very thin, fill=white] (C) rectangle (D);
                % Side of the 3D stack
                % See https://tex.stackexchange.com/questions/4057/cycle-option-when-drawing-between-nodes-in-tikz
                % for the explanation of .center
                \draw[black,very thin, fill=white] (A.center) -- (E.center) -- (F.center) -- (C.center) -- cycle;
                % Top of the 3D stack
                \draw[black,very thin, fill=white] (A.center) -- (G.center) -- (H.center) -- (C.center) -- cycle;

                % Draw the frame number
                \tikzmath{\frame = int(7-\n);}
                \node[anchor=north west] at (H) {Fr. \frame};
            }


        \foreach \i [count=\n] in {-1,-0.4,...,3}
            {
                %   G----A
                %  /|   / |
                % H-----C |
                % | B---|-E
                % |/    |/
                % D-----F
                \node (A) at (-\i+9.4, -\i+1.4) {};
                \node (B) at (-\i+8.2, -\i+0.2) {};
                \node (C) at (-\i+9.2, -\i+1.2) {};
                \node (D) at (-\i+8, -\i) {};
                \node (E) at (-\i+9.4, -\i+0.2) {};
                \node (F) at (-\i+9.2, -\i) {};
                \node (G) at (-\i+8.2, -\i+1.4) {};
                \node (H) at (-\i+8, -\i+1.2) {};

                % Red channel
                % Back of the 3D stack
                \draw[black,very thin, fill=red] (A) rectangle (B);
                % Front of the 3D stack
                \draw[black,very thin, fill=red] (C) rectangle (D);
                % Side of the 3D stack
                % See https://tex.stackexchange.com/questions/4057/cycle-option-when-drawing-between-nodes-in-tikz
                % for the explanation of .center
                \draw[black,very thin, fill=red] (A.center) -- (E.center) -- (F.center) -- (C.center) -- cycle;
                % Top of the 3D stack
                \draw[black,very thin, fill=red] (A.center) -- (G.center) -- (H.center) -- (C.center) -- cycle;

                % Green channel
                % Back of the 3D stack
                \draw[black,very thin, fill=green] ($(A) + (2, 0)$) rectangle ($(B) + (2, 0)$);
                % Front of the 3D stack
                \draw[black,very thin, fill=green] ($(C) + (2, 0)$) rectangle ($(D) + (2, 0)$);
                % Side of the 3D stack
                % See https://tex.stackexchange.com/questions/4057/cycle-option-when-drawing-between-nodes-in-tikz
                % for the explanation of .center
                \draw[black,very thin, fill=green] ($(A.center) + (2, 0)$) -- ($(E.center) + (2, 0)$) -- ($(F.center) + (2, 0)$) -- ($(C.center) + (2, 0)$) -- cycle;
                % Top of the 3D stack
                \draw[black,very thin, fill=green] ($(A.center) + (2, 0)$) -- ($(G.center) + (2, 0)$) -- ($(H.center) + (2, 0)$) -- ($(C.center) + (2, 0)$) -- cycle;

                % Blue channel
                % Back of the 3D stack
                \draw[black,very thin, fill=blue] ($(A) + (4, 0)$) rectangle ($(B) + (4, 0)$);
                % Front of the 3D stack
                \draw[black,very thin, fill=blue] ($(C) + (4, 0)$) rectangle ($(D) + (4, 0)$);
                % Side of the 3D stack
                % See https://tex.stackexchange.com/questions/4057/cycle-option-when-drawing-between-nodes-in-tikz
                % for the explanation of .center
                \draw[black,very thin, fill=blue] ($(A.center) + (4, 0)$) -- ($(E.center) + (4, 0)$) -- ($(F.center) + (4, 0)$) -- ($(C.center) + (4, 0)$) -- cycle;
                % Top of the 3D stack
                \draw[black,very thin, fill=blue] ($(A.center) + (4, 0)$) -- ($(G.center) + (4, 0)$) -- ($(H.center) + (4, 0)$) -- ($(C.center) + (4, 0)$) -- cycle;

                % Draw the frame number
                \tikzmath{\frame = int(7-\n);}
                \node[anchor=north west] at (H) {Fr. \frame};
                \node[anchor=north west] at ($(H) + (2,0)$) {Fr. \frame};
                \node[anchor=north west] at ($(H) + (4,0)$) {Fr. \frame};
            }

        \node [anchor=north] at (4.8, 3.5) {\textbf{Video of 3D stacks}};
        \node [anchor=north] at (4.8, 3) {\textbf{(4D tensor)}};

        \node [anchor=north] at (10.6, 3.5) {\textbf{Video of 3D RGB stacks}};
        \node [anchor=north] at (10.6, 3) {\textbf{(5D tensor)}};

    \end{tikzpicture}
\end{frame}

\begin{frame}
    {Videos in biomedical imaging}
    \begin{itemize}
        \item Many biological processes are dynamic and capturing/analysing them is a challenging task.
        \item Often tradeoff between acquisition speed and image quality is needed.
        \item Need analysis methods that are robust to noise and outliers.
        \item Generally we want to find object(s) of interest in each frame and be able to identify them across frames.
    \end{itemize}
\end{frame}

\begin{frame}
    {Some examples}
    Examples of dynamic biological processes captured in videos.
    \begin{itemize}[<+->]
        \item Tracking single molecules, vesicles, organelles in a cell
        \item Tracking cells in a dish or in a tissue
        \item Tracking a mouse during a behavioural experiment
    \end{itemize}

    \centering
    \only<1>{
        \includegraphics[width=.5\textwidth]{Choquet_Triller_2003_single_molecule_tracking.png}

        \footnotesize
        Choquet and Triller, 2003 - Tracking of AMPA receptors on a cell.
    }
    \only<2>{
        \includegraphics[width=.5\textwidth]{Perkin_Elmer_cell_tracking.jpg}

        \footnotesize
        Perkin Elmer - Tracking of cells in a dish.
    }
    \only<3>{
        \includegraphics[width=.7\textwidth]{Zhang_2020_mouse_tracking.png}

        \footnotesize
        Mouse tracking in a behavioural experiment.
    }
\end{frame}

\begin{frame}
    {A general motion tracking pipeline}

    \begin{enumerate}
        \item (\textit{optional}) Registration of the video
        \item Object detection
        \item Object tracking
        \item Measurement of object properties over time
    \end{enumerate}
\end{frame}

\section{Registration}

\begin{frame}
    {Registration}
    Registration (or video stabilization) is the process of aligning the video frames to a reference frame; this is done to correct for the movement of the camera or of the sample.
    \pause

    For instance, registration is useful for correcting:

    \begin{itemize}
        \item In vivo imaging where breathing artefacts can shift the field of view
        \item Drifting of the sample under a microscope
        \item Aligning MRI from the same subject in different sessions
    \end{itemize}
\end{frame}

\begin{frame}
    {Registration - motivation}
    Registration is important because otherwise quantification could be inaccurate.

    \centering
    \begin{tikzpicture}[scale=.8]
        \foreach \i [count=\n] in {0,3.5,7,10.5}
            {
                \draw[black,very thin, fill=white] (\i, 0) rectangle ({\i+3}, 3);
                \draw[gray,very thin, step=.25] (\i, 0) grid ({\i+3}, 3);

                \draw[black,very thin, fill=blue, opacity=0.6] ({\i+1.5+\n*(-0.19)}, 1.5) circle (0.8);
                \node (cellA) at ({\i+1.5+\n*(-0.19)}, 1.5) {};
                \node (cellB) at ({0.8+\i*1.001},{1.2}) {};
                \draw[very thin, fill=cyan] (cellA) circle (0.1);
                \draw[very thin, fill=orange] (cellB) circle (0.1);
            }
    \end{tikzpicture}

    \raggedright
    The orange cell is moving horizontally to the right, while the cyan cell is fixed; because the coverslip is drifting to the left, the coordinates of the orange cell stay fixed, while the cyan cell appers to move to the left.

    \pause
    While it is relatively straightforward to correct for this drift, drift in the z-axis is much more complex, as it changes the plane of focus that is being imaged.
\end{frame}

\begin{frame}
    {Types of registration algorithms}
    We can classify registration algorithms into

    \begin{itemize}
        \item \textbf{Intensity-based} - compare intensity patterns between the reference and the current frame via correlation
        \item \textbf{Feature-based} - find correspondences between features (points, corners etc) in the reference and the current frame
        \item \textbf{Mixed approaches}
    \end{itemize}

    \pause
    Registration can be performed through:

    \begin{itemize}
        \item \textbf{Rigid-body transformations} - translations and rotations only
        \item \textbf{Non-linear transformations} - including affine transformations (scaling, shearing)perspective transformations, curved transformations etc
    \end{itemize}
\end{frame}

\begin{frame}
    {Rigid-body registration}
    \textbf{Rigid-body} transformation is the simplest form of registration, consisting only of \textbf{translations and rotations}.

    Remember from Lecture 2:

    \centering
    \textbf{Translation}
    $$\begin{bmatrix}x'\\y'\\1\end{bmatrix} = \begin{bmatrix}1&0&t_x\\0&1&t_y\\0&0&1\end{bmatrix}\begin{bmatrix}x\\y\\1\end{bmatrix}$$
    \textbf{Rotation}
    $$\begin{bmatrix}x'\\y'\\1\end{bmatrix} = \begin{bmatrix}\text{cos}\theta&-\text{sin}\theta&0\\\text{sin}\theta&\text{cos}\theta&0\\0&0&1\end{bmatrix}\begin{bmatrix}x\\y\\1\end{bmatrix}$$
    % \textbf{Scaling}
    % $$\begin{bmatrix}x'\\y'\\1\end{bmatrix} = \begin{bmatrix}s_x&0&0\\0&s_y&0\\0&0&1\end{bmatrix}\begin{bmatrix}x\\y\\1\end{bmatrix}$$
\end{frame}

\begin{frame}
    {Rigid-body registration process}
    We want to find a transformation (translation+rotation) that maps the reference frame to the current frame.

    For \textbf{intensity-based registration}, given a frame at time $t$ and a reference frame at time $t_1$, we can find the offset $(u,v)$ that minimizes the MSE:

    \Large
    $$(u,v) = \underset{(u,v)}{\text{argmin}}\sum_x\sum_y(I_{i-1}(x,y)-I_{i}(x-u, y-v))^2$$

    \normalsize
    Alternatively, one could maximise the correlation between the two frames:

    \Large
    $$(u,v) = \underset{(u,v)}{\text{argmax}}\sum_x\sum_y(I_{i-1}(x,y)\cdot I_{i}(x-u, y-v))^2$$
\end{frame}

\begin{frame}
    {Registration - example}
    \includegraphics[width=\textwidth]{Lorenz2013_registration.png}

    \footnotesize
    Maximum intensity projection (over the time axis) of a video of kidney vascular flow. Rigid body registration is used to correct for the drift of the sample.
\end{frame}

\begin{frame}
    {Feature-based registration}
    Feature-based registration is based on the idea that there are static features in the video, that can be used to match images from one frame to another.
    \centering
    \includegraphics[width=.5\textwidth]{Alam2017_registration.png}

    \footnotesize
    Feature-based non-linear registration of brain MRI images.
\end{frame}
\section{Object detection and tracking}

\begin{frame}
    {Object detection}
    Object detection in a video is the same process than in a single image.

    All the segmentation techniques we have seen so far are applicable in this case as well!
\end{frame}

\begin{frame}
    {Object tracking}
    Once we found the object(s) of interest in each frame we want to be able to track them over time.

    That is, given $n$ object in a frame, $O_1, O_2, \ldots, O_n$ and $n$ we want to match each of them to the same object in the previous frame.
\end{frame}

\begin{frame}
    {Nearest-neighbour traking}
    If the objects are spaced far apart and do not make large movements from frame to frame, we can use a \textbf{nearest-neighbour} approach.

    \pause

    \begin{itemize}
        \item For each detected object we create a window of size $w$ containing it.
        \item We find the object in the next frame that is closest to the object of interest within that window.
              \pause
        \item Improved by predicting the position of the window surrounding the object, based on the displacement in previous frames
        \item The window could be expanded if no object is found.
    \end{itemize}
\end{frame}

\begin{frame}
    {Greedy algorithms}
    Nearest-neighbour tracking can only handle simple situations. For example, it fails if the object disappears for a certain time.

    In this case, we can use a \textbf{greedy algorithm} instead.

    \begin{itemize}[<+->]
        \item For each object $O$ in frame $n$ we define a window surrounding it.
        \item We look in frame $n+1$ for any object in the window.
        \item We score each object according to a metric (e.g. intensity correlation, or position).
        \item We select the object with the highest score and keep it as a match.
        \item If subsequent frames contradict the match, we step back and take the second best object.
        \item We can also add dummy object with a score of zero, which we can use as placeholders for disappearing objects (either ending that track or "putting it on hold" until it reappears).
    \end{itemize}

    \pause
    This type of algorithm works well with relatively sparse and slow moving objects.
\end{frame}

\begin{frame}
    {Histogram tracking}
    Another popular algorithm is the \textbf{mean-shift} algorithm.

    \begin{itemize}[<+->]
        \item We compute the histogram for our object of interest
        \item We then "back-project" the histogram onto the new frame. This means that we take each pixel in the search window and sum the probability of their intensities in the histogram.
        \item We then try to maximise this probability by shifting the search window. 
    \end{itemize}
\end{frame}
\section {Measurement of object properties}

\begin{frame}
    {Measuring cell properties}
    Just as we saw in the segmentation lecture we can use the \texttt{regionprops} function to measure properties of the detected objects.

    We will simply measure these properties in each frame by applying the function multiple times.
    
    Furthermore knowing the position of the object(s) in each frame we can calculate their direction and speed. 
\end{frame}

\begin{frame}
    {And now an example!}

    I will now show an example of analysis of a simple video.
\end{frame}

\end{document}

